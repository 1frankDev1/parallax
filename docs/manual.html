<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Menutech - Manuscrito Ilustrado</title>
    <link rel="icon" type="image/png" sizes="192x192" href="./assets/img/Dise√±o%20sin%20t√≠tulo%20(8).png">
    <link rel="stylesheet" href="./assets/css/badge.css">
    <link rel="stylesheet" href="./assets/css/medieval.css">
    <!-- PDF.js para extracci√≥n y renderizado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body {
            font-family: 'Cormorant Garamond', serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            color: #fff;
        }

        #manual-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
        }

        /* Sidebar Draggable Panel */
        #indexer-panel {
            user-select: none;
            position: absolute;
            top: 100px;
            left: 30px;
            width: 280px;
            background: rgba(15, 10, 7, 0.85);
            backdrop-filter: blur(10px);
            border: 2px solid #d4af37;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            z-index: 1000;
            transition: width 0.3s ease, height 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #indexer-header {
            padding: 12px;
            background: #2c1e14;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #d4af37;
        }

        #indexer-header h3 {
            margin: 0;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: #d4af37;
        }

        #collapse-btn {
            background: none;
            border: none;
            color: #d4af37;
            cursor: pointer;
            font-size: 1.5rem;
            font-family: 'Cinzel', serif;
        }

        #indexer-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            max-height: 70vh;
        }

        .index-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            font-family: 'Cinzel', serif;
            color: #ccc;
            font-size: 0.9rem;
        }

        .index-item:hover {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }

        .index-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-left-color: #d4af37;
            color: #fff;
        }

        /* Main Content Area */
        #main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: transparent;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        /* Collapsed state */
        #indexer-panel.collapsed {
            width: 50px;
            height: 50px;
        }
        #indexer-panel.collapsed #indexer-content,
        #indexer-panel.collapsed #indexer-header h3 {
            display: none;
        }

        /* Utils */
        .loading-overlay {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: 'Cinzel', serif;
            color: #d4af37;
            font-size: 2rem;
        }
    </style>
</head>
<body>
    <menutech-navweb></menutech-navweb>
    <menutech-drawer id="main-drawer" class="hidden"></menutech-drawer>
    <menutech-themes></menutech-themes>
    <menutech-chatbot></menutech-chatbot>
    <menutech-tools></menutech-tools>

    <div id="time-lock-overlay" class="time-lock-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; color: white; justify-content: center; align-items: center; text-align: center;">
        <div>
            <h2>Fuera de Horario Laboral</h2>
            <p>El acceso est√° restringido a tu horario de trabajo. Por favor, vuelve m√°s tarde.</p>
        </div>
    </div>

    <img id="login-icon" class="login-icon" src="./assets/img/user.svg">
    <div id="user-badge" class="user-badge hidden" style="position: fixed;">
        <div class="user-info">
            <span id="user-name" class="user-name">Usuario</span>
            <span id="user-role" class="user-role">Rol</span>
        </div>
        <div id="unread-badge" class="unread-badge hidden">0</div>
    </div>

    <div id="badge-menu" class="hidden">
        <button id="logout-btn">Cerrar Sesi√≥n</button>
    </div>

    <div id="manual-container">
        <div id="indexer-panel">
            <div id="indexer-header">
                <h3>üìú Manuscritos</h3>
                <button id="collapse-btn">‚àí</button>
            </div>
            <div id="indexer-content">
                <!-- Titles loaded from Supabase -->
            </div>
        </div>

        <div id="main-content">
            <!-- Dynamic Medieval Content -->
        </div>
    </div>

    <!-- NAVBAR NEOM√ìRFICO INFERIOR -->
    <div class="neo-nav-container">
        <button id="neoNavBack" class="neo-nav-btn">
            <svg viewBox="0 0 24 24" class="neo-nav-icon">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <button id="neoNavHome" class="neo-nav-btn">
            <svg viewBox="0 0 24 24" class="neo-nav-icon">
                <path d="M3 11l9-7 9 7v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tiny-animate/1.1.0/tinyanimate.min.js"></script>
    <script src="./assets/js/badge.js"></script>
    <script src="https://menutech.xyz/menutechUI.min.js"></script>
    <script src="./assets/js/renderer.js"></script>
    <script>
        let supabase = null;
        let manualData = [];

        async function initSupabase() {
            try {
                const mod = await import("https://esm.sh/@supabase/supabase-js");
                supabase = mod.createClient(
                    "https://ojpyfjgkffmzwvukjagf.supabase.co",
                    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcHlmamdrZmZtend2dWtqYWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDIwMzYsImV4cCI6MjA3OTcxODAzNn0.dlVYmoMumBse_O1PLBx0FeNITqY4YktefD6l_uonSgo"
                );
                return supabase;
            } catch (err) {
                console.error("Error al inicializar Supabase:", err);
                return null;
            }
        }

        async function loadContent() {
            const client = await initSupabase();
            if (!client) return;

            const { data, error } = await client
                .from('manual_content')
                .select('*')
                .order('created_at', { ascending: true });

            if (error) {
                console.error("Error cargando manual_content:", error);
                return;
            }

            manualData = data;
            const indexerContent = document.getElementById('indexer-content');
            indexerContent.innerHTML = '';

            if (manualData.length === 0) {
                indexerContent.innerHTML = '<div class="index-item">Sinfon√≠a vac√≠a</div>';
                showWelcome();
                return;
            }

            manualData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'index-item' + (index === 0 ? ' active' : '');
                itemDiv.innerText = item.title;
                itemDiv.onclick = () => selectItem(index);
                indexerContent.appendChild(itemDiv);
            });

            selectItem(0);
        }

        function showWelcome() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="medieval-container">
                    <h1 class="medieval-header">Bienvenido al Archivo de Menutech</h1>
                    <div class="medieval-text">
                        <span class="capitular">E</span>n estas p√°ginas yacen los secretos y gu√≠as para dominar el arte de nuestras herramientas.
                        Explora los manuscritos en el panel izquierdo para comenzar tu aprendizaje.
                    </div>
                    <div class="medieval-divider"><span>‚ù¶</span></div>
                    <img src="./assets/img/mks%20(9).png" class="medieval-engraving" style="max-width: 300px;">
                </div>
            `;
        }

        async function selectItem(index) {
            const item = manualData[index];
            if (!item) return;

            document.querySelectorAll('.index-item').forEach((div, i) => {
                div.classList.toggle('active', i === index);
            });

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="loading-overlay">Descifrando Pergamino...</div>';

            if (item.type === 'pdf') await renderPDF(item);
            else if (item.type === 'image') renderImage(item);
            else if (item.type === 'text') await renderText(item);
            else if (item.type === 'video') renderVideo(item);
            else showWelcome();
        }

        function formatMedieval(text) {
            if (!text) return '';
            const paragraphs = text.split('\n').map(p => p.trim()).filter(p => p.length > 0);
            return paragraphs.map((p, i) => {
                if (i === 0) {
                    const first = p.charAt(0);
                    const rest = p.slice(1);
                    return `<p class="medieval-text"><span class="capitular">${first}</span>${rest}</p>`;
                }
                return `<p class="medieval-text">${p}</p>`;
            }).join('');
        }

        async function renderText(item) {
            let content = item.description || '';
            if (item.source_url) {
                try {
                    const res = await fetch(item.source_url);
                    if (res.ok) {
                        const txt = await res.text();
                        if (txt.length > 5) content = txt;
                    }
                } catch (e) {}
            }
            document.getElementById('main-content').innerHTML = `
                <div class="medieval-container">
                    <h1 class="medieval-header">${item.title}</h1>
                    <div class="medieval-text">${formatMedieval(content)}</div>
                </div>
            `;
        }

        function renderImage(item) {
            document.getElementById('main-content').innerHTML = `
                <div class="medieval-container">
                    <h1 class="medieval-header">${item.title}</h1>
                    <img src="${item.source_url}" class="medieval-engraving">
                    <div class="medieval-divider"><span>‚ù¶</span></div>
                    <div class="medieval-text">${formatMedieval(item.description)}</div>
                </div>
            `;
        }

        async function renderPDF(item) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="medieval-container">
                    <h1 class="medieval-header">${item.title}</h1>
                    <div id="pdf-container"></div>
                </div>
            `;
            const container = document.getElementById('pdf-container');

            try {
                const pdf = await pdfjsLib.getDocument(item.source_url).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();

                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'medieval-page';
                    pageDiv.innerHTML = `<div class="pdf-page-header">Folio ${i} / ${pdf.numPages}</div>`;

                    // Extraer texto
                    let lastY, pageText = '';
                    textContent.items.forEach(t => {
                        if (lastY !== undefined && Math.abs(lastY - t.transform[5]) > 10) pageText += '\n';
                        pageText += t.str;
                        lastY = t.transform[5];
                    });

                    const textDiv = document.createElement('div');
                    textDiv.innerHTML = formatMedieval(pageText);
                    pageDiv.appendChild(textDiv);

                    // Renderizar p√°gina como grabado
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    img.className = 'medieval-engraving';
                    pageDiv.appendChild(img);

                    container.appendChild(pageDiv);
                    if (i < pdf.numPages) {
                        const div = document.createElement('div');
                        div.className = 'medieval-divider';
                        div.innerHTML = '<span>‚ù¶</span>';
                        container.appendChild(div);
                    }
                }
            } catch (e) {
                container.innerHTML = `<p class="medieval-text">Error al descifrar el manuscrito: ${e.message}</p>`;
            }
        }

        function renderVideo(item) {
            let videoHTML = '';
            if (item.source_url.includes('youtube.com') || item.source_url.includes('youtu.be')) {
                const id = item.source_url.includes('v=') ? item.source_url.split('v=')[1].split('&')[0] : item.source_url.split('/').pop();
                videoHTML = `<iframe src="https://www.youtube.com/embed/${id}" style="width:100%; aspect-ratio:16/9; border:10px double #8b4513;" allowfullscreen></iframe>`;
            } else {
                videoHTML = `<video controls style="width:100%; border:10px double #8b4513;"><source src="${item.source_url}"></video>`;
            }
            document.getElementById('main-content').innerHTML = `
                <div class="medieval-container">
                    <h1 class="medieval-header">${item.title}</h1>
                    ${videoHTML}
                    <div class="medieval-divider"><span>‚ù¶</span></div>
                    <div class="medieval-text">${formatMedieval(item.description)}</div>
                </div>
            `;
        }

        // DRAGGABLE Logic
        const panel = document.getElementById('indexer-panel');
        const header = document.getElementById('indexer-header');
        let isDragging = false, offX, offY;

        header.onmousedown = (e) => {
            isDragging = true;
            offX = e.clientX - panel.offsetLeft;
            offY = e.clientY - panel.offsetTop;
        };
        document.onmousemove = (e) => {
            if (isDragging) {
                panel.style.left = (e.clientX - offX) + 'px';
                panel.style.top = (e.clientY - offY) + 'px';
            }
        };
        document.onmouseup = () => isDragging = false;

        document.getElementById('collapse-btn').onclick = () => {
            panel.classList.toggle('collapsed');
            document.getElementById('collapse-btn').innerText = panel.classList.contains('collapsed') ? '+' : '‚àí';
        };

        // NAV
        document.getElementById("neoNavBack").onclick = () => window.history.back();
        document.getElementById("neoNavHome").onclick = () => window.location.href = "index.html";

        loadContent();
    </script>
</body>
</html>
