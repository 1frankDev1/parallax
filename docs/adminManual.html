<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Manual Menutech</title>
    <link rel="stylesheet" href="./assets/css/badge.css">
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #2c2c2c;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            animation: fadeIn 0.5s ease-in-out;
            padding-bottom: 150px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #00bcd4;
            text-align: center;
            margin-top: 40px;
        }

        .form-container {
            background-color: #3d3d3d;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-bottom: 40px;
        }

        .form-container h2 {
            margin-top: 0;
            color: #00bcd4;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #ccc;
        }

        input, select, textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #444;
            color: #fff;
            font-size: 1rem;
        }

        textarea {
            resize: vertical;
            height: 100px;
        }

        button {
            background-color: #ff8c00;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background-color: #e67e00;
        }

        .content-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #3d3d3d;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        th {
            background-color: #4a4a4a;
            color: #00bcd4;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .delete-btn { background-color: #f44336; }
        .delete-btn:hover { background-color: #d32f2f; }

        .type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-video { background: #ff4444; }
        .type-image { background: #44ff44; color: #000; }
        .type-pdf { background: #4444ff; }
        .type-text { background: #ffaa44; }

        .popup {
            position: fixed;
            top: 20px;
            right: -400px;
            width: 280px;
            padding: 20px;
            background-color: #333;
            color: white;
            border-left: 5px solid #00bcd4;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: right 0.5s ease-in-out;
            z-index: 10000;
        }
        .popup.show { right: 20px; }

        /* Drag and Drop Zone */
        .drop-zone {
            width: 80%;
            max-width: 600px;
            margin: 0 auto 20px auto;
            height: 150px;
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: "Quicksand", sans-serif;
            font-weight: 500;
            font-size: 20px;
            cursor: pointer;
            color: #ccc;
            border: 2px dashed #00bcd4;
            border-radius: 10px;
            transition: background 0.3s, border-color 0.3s;
        }

        .drop-zone--over {
            border-style: solid;
            background-color: rgba(0, 188, 212, 0.1);
        }

        .drop-zone__input {
            display: none;
        }

        .drop-zone__thumb {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
            background-color: #444;
            background-size: cover;
            position: relative;
        }

        .drop-zone__thumb::after {
            content: attr(data-label);
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 5px 0;
            color: #ffffff;
            background: rgba(0, 0, 0, 0.75);
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="popup" class="popup">Contenido guardado exitosamente</div>

    <img id="login-icon" class="login-icon" src="./assets/img/user.svg">
    <div id="user-badge" class="user-badge hidden" style="position: fixed;">
        <div id="badge-username"></div>
        <div id="badge-role"></div>
    </div>
    <div id="badge-menu" class="hidden">
        <button id="logout-btn" class="logout-btn">Cerrar sesión</button>
    </div>

    <div class="container">
        <h1>Manual Menutech</h1>

        <div class="form-container">
            <h2>Agregar Nuevo Contenido</h2>
            <form id="content-form">
                <div class="form-grid">
                    <div class="input-group">
                        <label>Título del Contenido</label>
                        <input type="text" id="title" required placeholder="Ej: Cómo realizar una venta">
                    </div>
                    <div class="input-group">
                        <label>URL / Fuente (Opcional si arrastras un archivo abajo)</label>
                        <input type="text" id="source" placeholder="https://youtube.com/...">
                    </div>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>Arrastra tus archivos aquí (Imágenes, Videos o PDFs)</label>
                    <div class="drop-zone">
                        <span class="drop-zone__prompt">Suelta el archivo aquí o haz clic para subir</span>
                        <input type="file" name="myFile" class="drop-zone__input" id="file-input">
                    </div>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>Descripción / Texto Adicional</label>
                    <textarea id="description" placeholder="Escribe información adicional aquí..."></textarea>
                </div>
                <button type="submit" style="display: block; margin: 30px auto 10px auto; min-width: 200px;">Guardar Contenido</button>
            </form>
        </div>

        <div id="content-list">
            <table class="content-table">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Tipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="content-table-body">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="neo-nav-container">
        <button id="neoNavBack" class="neo-nav-btn">
            <svg viewBox="0 0 24 24" class="neo-nav-icon">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"
                    fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <button id="neoNavHome" class="neo-nav-btn">
            <svg viewBox="0 0 24 24" class="neo-nav-icon">
                <path d="M3 11l9-7 9 7v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2
                        2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                    stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tiny-animate/1.1.0/tinyanimate.min.js"></script>
    <script src="./assets/js/badge.js"></script>
    <script src="https://menutech.xyz/menutechUI.min.js"></script>
    <script src="./assets/js/renderer.js"></script>
    <script>
        let supabase = null;
        let isInitializing = false;

        // Drag and Drop Logic
        document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
            const dropZoneElement = inputElement.closest(".drop-zone");

            dropZoneElement.addEventListener("click", (e) => {
                inputElement.click();
            });

            inputElement.addEventListener("change", (e) => {
                if (inputElement.files.length) {
                    updateThumbnail(dropZoneElement, inputElement.files[0]);
                }
            });

            dropZoneElement.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZoneElement.classList.add("drop-zone--over");
            });

            ["dragleave", "dragend"].forEach((type) => {
                dropZoneElement.addEventListener(type, (e) => {
                    dropZoneElement.classList.remove("drop-zone--over");
                });
            });

            dropZoneElement.addEventListener("drop", (e) => {
                e.preventDefault();

                if (e.dataTransfer.files.length) {
                    inputElement.files = e.dataTransfer.files;
                    updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
                }

                dropZoneElement.classList.remove("drop-zone--over");
            });
        });

        function updateThumbnail(dropZoneElement, file) {
            let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

            if (dropZoneElement.querySelector(".drop-zone__prompt")) {
                dropZoneElement.querySelector(".drop-zone__prompt").remove();
            }

            if (!thumbnailElement) {
                thumbnailElement = document.createElement("div");
                thumbnailElement.classList.add("drop-zone__thumb");
                dropZoneElement.appendChild(thumbnailElement);
            }

            thumbnailElement.dataset.label = file.name;

            if (file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
                };
            } else {
                thumbnailElement.style.backgroundImage = null;
            }
        }

        function resetDropZone() {
            const dropZoneElement = document.querySelector(".drop-zone");
            const thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");
            if (thumbnailElement) thumbnailElement.remove();

            if (!dropZoneElement.querySelector(".drop-zone__prompt")) {
                const prompt = document.createElement("span");
                prompt.classList.add("drop-zone__prompt");
                prompt.innerText = "Suelta el archivo aquí o haz clic para subir";
                dropZoneElement.appendChild(prompt);
            }
            document.getElementById('file-input').value = "";
        }

        async function initSupabase(retries = 3) {
            if (supabase) return supabase;
            if (isInitializing) {
                while (isInitializing) await new Promise(r => setTimeout(r, 100));
                return supabase;
            }
            isInitializing = true;

            for (let i = 0; i < retries; i++) {
                try {
                    const mod = await import("https://esm.sh/@supabase/supabase-js");
                    const createClient = mod.createClient;
                    supabase = createClient(
                        "https://ojpyfjgkffmzwvukjagf.supabase.co",
                        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcHlmamdrZmZtend2dWtqYWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDIwMzYsImV4cCI6MjA3OTcxODAzNn0.dlVYmoMumBse_O1PLBx0FeNITqY4YktefD6l_uonSgo"
                    );
                    console.log("Supabase inicializado en Admin");
                    break;
                } catch (err) {
                    console.error(`Error cargando Supabase (intento ${i + 1}):`, err);
                    if (i < retries - 1) await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            isInitializing = false;
            return supabase;
        }

        async function loadItems() {
            const client = await initSupabase();
            if (!client) return;

            const { data, error } = await client
                .from('manual_content')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error cargando items:", error);
                return;
            }

            const tbody = document.getElementById('content-table-body');
            tbody.innerHTML = '';

            data.forEach((item) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.title}</td>
                    <td><span class="type-badge type-${item.type}">${item.type}</span></td>
                    <td>
                        <button class="action-btn delete-btn" onclick="deleteItem('${item.id}', '${item.source_url}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.deleteItem = async function(id, sourceUrl) {
            if (!confirm("¿Estás seguro de eliminar este contenido?")) return;
            const client = await initSupabase();

            // Si el archivo está en nuestro storage, intentar borrarlo
            if (sourceUrl && sourceUrl.includes('/storage/v1/object/public/manual/')) {
                const fileName = sourceUrl.split('/').pop();
                await client.storage.from('manual').remove([fileName]);
            }

            const { error } = await client
                .from('manual_content')
                .delete()
                .eq('id', id);

            if (error) console.error("Error al eliminar:", error);
            else loadItems();
        };

        function detectType(file, sourceUrl) {
            if (file) {
                if (file.type.startsWith("image/")) return "image";
                if (file.type.startsWith("video/")) return "video";
                if (file.type === "application/pdf") return "pdf";
                return "text";
            }
            if (sourceUrl) {
                const url = sourceUrl.toLowerCase();
                if (url.includes("youtube.com") || url.includes("youtu.be")) return "video";
                if (url.endsWith(".jpg") || url.endsWith(".png") || url.endsWith(".webp") || url.endsWith(".jpeg")) return "image";
                if (url.endsWith(".mp4") || url.endsWith(".webm") || url.endsWith(".ogg")) return "video";
                if (url.endsWith(".pdf")) return "pdf";
            }
            return "text";
        }

        document.getElementById('content-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const client = await initSupabase();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerText = "Guardando...";

            let source_url = document.getElementById('source').value;
            const fileInput = document.getElementById('file-input');
            let file = fileInput.files.length > 0 ? fileInput.files[0] : null;

            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = fileName;

                const { data: uploadData, error: uploadError } = await client.storage
                    .from('manual')
                    .upload(filePath, file);

                if (uploadError) {
                    console.error("Error al subir archivo:", uploadError);
                    alert("Error al subir archivo: " + uploadError.message);
                    btn.disabled = false;
                    btn.innerText = "Guardar Contenido";
                    return;
                }

                const { data: urlData } = client.storage
                    .from('manual')
                    .getPublicUrl(filePath);

                source_url = urlData.publicUrl;
            }

            const contentType = detectType(file, source_url);

            const { error } = await client.from('manual_content').insert([{
                title: document.getElementById('title').value,
                type: contentType,
                source_url: source_url,
                description: document.getElementById('description').value
            }]);

            if (error) {
                console.error("Error al guardar metadata:", error);
                alert("Error al guardar en base de datos: " + error.message);
            } else {
                const popup = document.getElementById('popup');
                popup.classList.add('show');
                setTimeout(() => popup.classList.remove('show'), 3000);
                e.target.reset();
                resetDropZone();
                loadItems();
            }

            btn.disabled = false;
            btn.innerText = "Guardar Contenido";
        });

        loadItems();

        const neoNavBack = document.getElementById("neoNavBack");
        if (neoNavBack) {
            neoNavBack.addEventListener("click", () => {
                if (window.history.length > 1) window.history.back();
                else window.location.href = "index.html";
            });
        }

        const neoNavHome = document.getElementById("neoNavHome");
        if (neoNavHome) {
            neoNavHome.addEventListener("click", () => {
                window.location.href = "index.html";
            });
        }
    </script>
</body>
</html>
